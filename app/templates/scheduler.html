<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cron Job Scheduler</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding-top: 20px; background-color: #f8f9fa; }
        .card { box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: none; }
        .code-block { background: #2d2d2d; color: #f8f8f2; padding: 10px; border-radius: 4px; font-family: monospace; }
    </style>
</head>
<body>
    <div class="container">
        <header class="pb-3 mb-4 border-bottom">
            <span class="fs-4">üóìÔ∏è BigQuery Cron Scheduler</span>
            <span class="float-end text-muted">Running on Cloud Run</span>
        </header>

        <div class="row">
            <div class="col-12">
                <div class="card p-4">
                    <div class="d-flex justify-content-between mb-3">
                        <h5>Active Cron Jobs</h5>
                        <button class="btn btn-primary btn-sm" onclick="loadJobs()">üîÑ Refresh</button>
                    </div>
                    <div id="loading" class="text-center my-5">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2">Connecting to Ubuntu Server...</p>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle" id="jobsTable" style="display:none;">
                            <thead class="table-light">
                                <tr>
                                    <th width="15%">Schedule</th>
                                    <th width="50%">Command</th>
                                    <th width="35%">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Jobs will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
             <div class="col-12">
                <div class="card p-4 bg-dark text-white">
                    <h5>üñ•Ô∏è Output Console</h5>
                    <div id="console" class="code-block" style="min-height: 150px; white-space: pre-wrap;">Ready...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Schedule</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editForm">
                        <input type="hidden" id="originalRaw">
                        <div class="mb-3">
                            <label class="form-label">Cron Schedule</label>
                            <input type="text" class="form-control font-monospace" id="editSchedule" placeholder="0 5 * * *">
                            <div class="form-text">Reference: Minute Hour Day Month DayOfWeek</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Command</label>
                            <input type="text" class="form-control font-monospace" id="editCommand">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveJob()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Extract API Key from URL if present
        const urlParams = new URLSearchParams(window.location.search);
        const apiKey = urlParams.get('api_key');
        
        async function apiCall(endpoint, method='GET', body=null) {
            const headers = { 'Content-Type': 'application/json' };
            if (apiKey) headers['Authorization'] = `Bearer ${apiKey}`;
            
            const response = await fetch(endpoint, {
                method,
                headers,
                body: body ? JSON.stringify(body) : null
            });
            
            if (response.status === 401 || response.status === 403) {
                log("‚ùå Unauthorized: Missing or Invalid API Key");
                throw new Error("Unauthorized");
            }
            return response.json();
        }

        function log(message) {
            const consoleDiv = document.getElementById('console');
            consoleDiv.innerText = `[${new Date().toLocaleTimeString()}] ${message}\n` + consoleDiv.innerText;
        }

        async function loadJobs() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('jobsTable').style.display = 'none';
            
            try {
                const jobs = await apiCall('/api/cron/jobs');
                const tbody = document.querySelector('#jobsTable tbody');
                tbody.innerHTML = '';
                
                jobs.forEach((job, index) => {
                    const row = `
                        <tr>
                            <td class="font-monospace fw-bold text-primary">${job.schedule}</td>
                            <td class="font-monospace small text-break">${job.command}</td>
                            <td>
                                <button class="btn btn-sm btn-success me-2" onclick="runJob(${index})">‚ñ∂Ô∏è Run Now</button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="openEdit(${index})">‚úèÔ∏è Edit</button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
                
                // Store jobs globally for easy access
                window.currentJobs = jobs;
                
                document.getElementById('jobsTable').style.display = 'table';
            } catch (e) {
                log("Error loading jobs: " + e.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        async function runJob(index) {
            const job = window.currentJobs[index];
            if (!confirm(`Are you sure you want to run this command?\n\n${job.command}`)) return;
            
            log(`Running: ${job.command}...`);
            try {
                const result = await apiCall('/api/cron/jobs/run', 'POST', { command: job.command });
                log(`Result:\n${result.output}`);
            } catch (e) {
                log("Error running job: " + e.message);
            }
        }

        function openEdit(index) {
            const job = window.currentJobs[index];
            document.getElementById('originalRaw').value = job.raw;
            document.getElementById('editSchedule').value = job.schedule;
            document.getElementById('editCommand').value = job.command;
            new bootstrap.Modal(document.getElementById('editModal')).show();
        }

        async function saveJob() {
            const oldRaw = document.getElementById('originalRaw').value;
            const newSchedule = document.getElementById('editSchedule').value;
            const newCommand = document.getElementById('editCommand').value;
            
            try {
                const result = await apiCall('/api/cron/jobs/update', 'POST', {
                    old_raw: oldRaw,
                    new_schedule: newSchedule,
                    new_command: newCommand
                });
                
                if (result.success) {
                    bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
                    log("‚úÖ Schedule updated successfully.");
                    loadJobs();
                } else {
                    log("‚ùå Failed to update schedule.");
                }
            } catch (e) {
                log("Error updating job: " + e.message);
            }
        }

        // Initial Load
        loadJobs();
    </script>
</body>
</html>
